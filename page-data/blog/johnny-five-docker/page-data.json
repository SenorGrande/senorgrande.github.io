{"componentChunkName":"component---src-templates-blog-js","path":"/blog/johnny-five-docker","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Using Johnny Five with Node-RED and Docker","date":"2019-06-24"},"html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.23404255319149%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABYklEQVQY0z1QzUsCQRT3T+lUJ6+aJenMzox0rQ4RgUrdOnSILtEf0KFDpyAoOoRESVERFWtmmWluCmauiqsp5K7h+rEXzWNvdy0YHo/35vf1LK0yMx6F15fpQCGDBvtR6KBBtCpVJQLzbpVB0yyRToW1JKJK1PjPLCasXWGwuwy4Avvc8QF3ckiP9jgxzmk1CvP7i3EA9GQP9Al+Qs4bLCYYFp1PpohodWXa6/MtLy36ffMzs3M3p6hXB1IaOrcLYefDlaOQdCf4SU03QsGCoWx4U0vk/RmnH7EQRq+8Kx1B3wXSksAUlVJu/szuXRhJhpzZ2FRXjwMo+g/WI3286OBM1C3GsZIn7TLEY2DqK4fvgraNtdGdLauYcBnKut4ws2k+F8epCMrGUFHARYHLRDHQ1UWi1VjpDe1uWzfXx0yYUYcHY394AuZBTdXt6HQQGHqofdnzdO24Ddp6dU9zeG36C3IZCkO6ILG9AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Johnny Five\"\n        title=\"Johnny Five\"\n        src=\"/static/9bbafa3b112cc845f1c8f7f5f9b9695f/8c557/johnny-five.png\"\n        srcset=\"/static/9bbafa3b112cc845f1c8f7f5f9b9695f/4dcb9/johnny-five.png 188w,\n/static/9bbafa3b112cc845f1c8f7f5f9b9695f/5ff7e/johnny-five.png 375w,\n/static/9bbafa3b112cc845f1c8f7f5f9b9695f/8c557/johnny-five.png 700w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>This article, I will show you how to create a Node-RED Docker container running on a Raspberry Pi. The Raspberry Pi connects to an Arduino to control and change the colour of an RGB LED, utilising the Johnny-Five framework.</p>\n<p>Prerequisites:</p>\n<ul>\n<li>Raspberry Pi with Docker and Docker Compose installed</li>\n<li>Arduino with the \"firmata\" script installed</li>\n<li>An RGB LED with 330 Ohm resistors</li>\n</ul>\n<p><a href=\"https://github.com/SenorGrande/hue-app\">All the code can be found at my GitHub repo</a><br>\nIncluded is a React App to demonstrate sending POST requests to the Node-RED HTTP endpoint.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.74468085106383%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAACvUlEQVQoz2P49u3bhfPnX799++f//3///3/89GnR4sVbt2z5+vffj79AAXyAIW36MglJKbO0Etf+pTqt80Onrjixd9eCNRsa56+6dPMuUMXjx4+BFmDX7Ns1R0BWUcUvUi8qnTGnR6psUtfi1YlTl6S1TT119gJQxcWLF1+/fg1k/MMADFXr95rk1mlVTBAsniBYMlGwuJ+nsE80v9OgqHnTtYdvXj4/dOzQxUsXHj58eO/evfv37z948OA+GAAZDC6TVmb1zoievpIhr1+gbKpYWr1scLJCcbeFu9eiXYdevn25+/T+o+dOHjl85NChQ8eOHTsOBgcOHDh79iyDR8fs+Oa+8L55bBlt/MWTJMsnmTRMVWiaJ51cMX/jjjevnu7cuezQvg0nT54+evToKQg4efLIkSNA7zAk1LYpl/VrRGepeIfxlE0TKZ1k27vEfvIaobjSBVt2v3589/CyqadWz7x45dqFc2cvXrgAQcAIugTUXNA/TbJyqnxEhpp3GG/5dP6iCWGzN0Qv2SUQW7xg664PT5/tOLBl4+nj506ePn7i+BkYALr/0qVLDC2LVum2LlCMyFD1CQdq5ivqd520wn/OZu6Eqjkb9zzfs3f25slz9h45e+LkkaNHTp48CXb1ycOHD58/f54hffICm65FimFpSh4hAhXTeQv61Btm205cI5NR1T2h9tCVbatPnjhx4f7jR/eBof0ADBChHVffod8wPbC8SS8kgb10GkfhRMPWeS5T10lm1NSsWHXj5bf7z7/hSmkM4ZXNkqUT1eMLnBOzDJtmyeS2KtZMFauZLZpQPnnxeqCKv//+/f2HHTAsO3wmZ+Vuh5YZpnVT4tonV0yYWrfpYOvWwwv3n3jxBpSw/uJO4QxA/P3X729//n798/fDj18ffv7+8es3nswAtPDjx4+vXr0CplkAa5BQooeMJbkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Arduino\"\n        title=\"Arduino\"\n        src=\"/static/9912532b83469bbf43164c02447732b4/8c557/arduino-led.png\"\n        srcset=\"/static/9912532b83469bbf43164c02447732b4/4dcb9/arduino-led.png 188w,\n/static/9912532b83469bbf43164c02447732b4/5ff7e/arduino-led.png 375w,\n/static/9912532b83469bbf43164c02447732b4/8c557/arduino-led.png 700w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<h2>Dockerfile of the Node-RED container</h2>\n<ol>\n<li>\n<p>We start with a base Node-RED image that is built for devices with ARM processors</p>\n<pre><code>FROM nodered/node-red-docker:rpi\n</code></pre>\n</li>\n<li>\n<p>The Dockerfile copies the flows and settings files into the image</p>\n<pre><code>COPY ./flows.json /data/flows.json\nCOPY ./settings.js /data/settings.js\n</code></pre>\n</li>\n<li>\n<p>Switch to root user so we can install NPM packages</p>\n<pre><code>USER root\n</code></pre>\n</li>\n<li>\n<p>Install johnny-five and other packages so that we can get the Johnny-five nodes in Node-RED</p>\n<pre><code>RUN npm install johnny-five --unsafe-perm --force \\\n&#x26;&#x26; npm install raspi-io --unsafe-perm --force \\\n&#x26;&#x26; npm install node-red-contrib-gpio --unsafe-perm --force\n</code></pre>\n</li>\n<li>\n<p>Add the node-red user to the <code>dialout</code> group so the container can connect to the Arduino</p>\n<pre><code>RUN usermod -a -G dialout node-red\n</code></pre>\n</li>\n<li>\n<p>Change the user to node-red as it is not good practice for a Docker container to be running as root</p>\n<pre><code>USER node-red\n</code></pre>\n</li>\n</ol>\n<h3>Putting it all together...</h3>\n<pre><code>FROM nodered/node-red-docker:rpi\n\nCOPY ./flows.json /data/flows.json\nCOPY ./settings.js /data/settings.js\n\nUSER root\n\nRUN npm install johnny-five --unsafe-perm --force \\\n&#x26;&#x26; npm install raspi-io --unsafe-perm --force \\\n&#x26;&#x26; npm install node-red-contrib-gpio --unsafe-perm --force\n\nRUN usermod -a -G dialout node-red\n\nUSER node-red\n</code></pre>\n<h2>Node-RED flow &#x26; settings</h2>\n<p>The flow consists of an HTTP endpoint node that will allow Node-RED to accept POST requests. For example, when a JSON payload contains an object such as <code>{colour:\"#ff0000\"}</code> (Red), the Johnny5 node will change the colour of the RGB LED to the colour specified.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 383px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.297872340425535%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABa0lEQVQY03WOy07CQBiFu/IBXLD23XwFg+AGjTHuvYCX6IqFgcSGSCKJJgoEDUIhBhoihVIovUHbaUtrbaZM7UDCwsvJycyXzH/+M8T8b/kIBY5jauM04PdVLjHldlVubybGLPVhjoJwIBwiFtdPI4Qsyx7zLN/ZnNIbvcp6pxzhqhGHWVPYQ+gHCEEcDoKQsFewZFlRgrlfHVIdjtLktiK+T6T2zOxDT0O4GYsAgDfNsWWNTZMPzyVA+KVpOoQQWAowJWDIhiHrQHbdz1UShznunm5fv1aOKCpVe0vWqWSvnx6wLYZhBUHgh3eyeNNsXNL0FT8qqNNOsPwiQjisql1dxwagBwCzAMZ1Z5KEewSpNRKpkdgYCdSAr4mTvm7olm350A9FBP/Itu2w+TR3HLuI7qRi8dR2PBWNnW0dpBPn5Em+nHMch/Dxkt/2w3z4/FgvkKXM7VOGfM6QxSxZyuZfcuVmsct9eJ73DSSJqJLS6RNmAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Node-RED\"\n        title=\"Node-RED\"\n        src=\"/static/b7a7a147090f77edc0f7c10babff0117/d0c94/node-red.png\"\n        srcset=\"/static/b7a7a147090f77edc0f7c10babff0117/4dcb9/node-red.png 188w,\n/static/b7a7a147090f77edc0f7c10babff0117/5ff7e/node-red.png 375w,\n/static/b7a7a147090f77edc0f7c10babff0117/d0c94/node-red.png 383w\"\n        sizes=\"(max-width: 383px) 100vw, 383px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\nThe Johnny5 Node is like a function node in Node-RED. However, it is triggered when the Node-RED flow first runs, and not on input. We can overcome this by including the following in our johnny5 node:</p>\n<pre><code>node.on('input', function(msg){});\n</code></pre>\n<p>This function is triggered when the node receives an input. In this flow, when a POST request is received by the endpoint, the Johnny5 node will set the led colour to the hex value stored in msg.payload.colour.</p>\n<h2>Johnny5 Node Code</h2>\n<pre><code>// Initialize the RGB LED\nvar led = new five.LED.RGB({\n  pins: {\n    red: 9,\n    green: 10,\n    blue: 11\n  }\n});\n\n// Turn it on and set the initial color\nled.on();\nled.color(\"#ffffff\");\n\nnode.on('input', function(msg) {\n  led.color(msg.payload.colour);\n});\n</code></pre>\n<h2>Settings.js</h2>\n<p>In the settings.js file, allow GET requests so we don't get CORS errors when trying to POST a colour from the example React App.</p>\n<pre><code>httpNodeCors: {\n  origin: \"*\",\n  methods: \"GET,PUT,POST,DELETE\"\n}\n</code></pre>\n<h2>Docker-Compose</h2>\n<p>The Docker Compose script consists of two services, the backend service is the Node-RED container and the frontend service is an Apache container that serves up the build folder of the example React app in the GitHub repo. The backend adds the Arduino Uno as a device to the customer, alter this to the address of the Arduino on the Raspberry Pi.</p>\n<pre><code>version: '3'\n  services:\n\n    backend:\n      build: ./backend\n      ports:\n        - \"1880:1880\"\n      devices:\n        - \"/dev/ttyACM0:/dev/ttyACM0\"\n\n    frontend:\n      build: ./frontend\n      ports:\n        - \"8090:80\"\n</code></pre>\n<p>Run <code>docker-compose up</code> in the same directory as the docker-compose.yml script to build and start both services, or follow the README in the GitHub Repo on how to build and run the containers individually.</p>\n<p>Thanks for reading.</p>"}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"johnny-five-docker"}}}