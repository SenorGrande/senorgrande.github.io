{"componentChunkName":"component---src-templates-blog-js","path":"/blog/node-red-npm","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Publishing a Node-RED package to NPM with GitHub Actions","date":"2019-12-17"},"html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 687px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.23404255319149%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABbElEQVQY00VQS07CUBTtAogBoaWFCtgCAi1Q/ohWZEIiRIUl6A6IjmAB8rcUsFBA0Ehw6FATnbkwT9Vocgcv953fPUSPdv5Nx2bvksz/hsGwyo5nIsXGQWESjam8bxQIaVJ84OG7dgcBUJcyCH2GncYT42AIhJ+l4vLcy7IWjoI5FkQtEtWTqYdC4alU0qKxkXeP6Nkdo6CwlOV5JgvckPO1tykjAkV3SPrW6YJW22LDpmUhVd5/J4gYqCMOMeC8s3T6sViELRB91v1ycfl2df1aq300Gqt8YRQSP1vt93r9uVKFXBfXkXTHSumJFKFFpB7t6NG/UWG1lPPrk/K6fLo5r2phSeH4zVkFzHk2h99pPLnIHagcr4kSMfQHxkJ4nt2HkuLe7TvYltmKYlBB02Q2rCimuWXB+8Zkxqmro2PEROaBmyOARmB0oKczi9zhDCrJ1CQWVznfd+FGIhiiMz2V0cIRnKnyXlQN0S8Von+wztTJrAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Node-RED\"\n        title=\"Node-RED\"\n        src=\"/static/1c46a7db8ba85675657f8b603296a110/aec65/node-red-npm.png\"\n        srcset=\"/static/1c46a7db8ba85675657f8b603296a110/4dcb9/node-red-npm.png 188w,\n/static/1c46a7db8ba85675657f8b603296a110/5ff7e/node-red-npm.png 375w,\n/static/1c46a7db8ba85675657f8b603296a110/aec65/node-red-npm.png 687w\"\n        sizes=\"(max-width: 687px) 100vw, 687px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>This article walks through how I created and published my Node-RED module “node-red-contrib-flatter” to NPM. Using the flat NPM package, it consists of two nodes to flatten and unflatten JavaScript objects.</p>\n<p><a href=\"https://www.npmjs.com/package/node-red-contrib-flatter\">https://www.npmjs.com/package/node-red-contrib-flatter</a></p>\n<p><a href=\"https://github.com/SenorGrande/node-red-contrib-flatter\">https://github.com/SenorGrande/node-red-contrib-flatter</a></p>\n<h2>Starting the node</h2>\n<p>Following the Node RED documentation to create a node that converts msg.payload to lowercase, I was able to create the foundation of my package.</p>\n<p><a href=\"https://nodered.org/docs/creating-nodes/first-node\">https://nodered.org/docs/creating-nodes/first-node</a></p>\n<h3>The main differences from the starter node:</h3>\n<p>In the Node-RED documentation, you create a lower-case.js file. For my package, I created a flatter.js &#x26; unflatter.js file, one for each node.\nI needed to require the “flat” NPM package, so I saved this as a dependency:\n<code>npm i --save flat</code></p>\n<p>I can now require this in my flatter.js and unflatter.js files:\n<code>var flatten = require('flat');</code>\n<code>var unflatten = require('flat');</code></p>\n<p>And instead of this line in the example lower-case.js file:\n<code>msg.payload = msg.payload.toLowerCase();</code>\nI replaced it with:\n<code>msg.payload = flatten(msg.payload);</code> in flatter.js, and<br>\n<code>msg.payload = unflatten(msg.payload);</code> in unflatter.js</p>\n<h2>Unit tests</h2>\n<p>Following the Node-RED documentation, I created a folder called “test” with a flatter_spec.js file. I only added a simple test for flattening and unflattening a payload and then checking the output matches the expected output.</p>\n<p>Below are the dependencies I saved to my package for developing, mocha and node-red-node-test-helper. Dependencies saved to “devDependencies” with\n<code>--save-dev</code> aren’t installed when someone installs your package from NPM.<br>\n<code>npm i --save-dev mocha node-red node-red-node-test-helper</code></p>\n<h2>Package.json</h2>\n<p>Add “node-red” as a keyword to package.json when you are ready and it should show up on the Node-RED library flows.nodered.org within a few hours. It can then be searched in the Node-RED palette manager. Only do this when your package is ready!\nAlso, add other keywords that relate to your package so that it can be searched for on NPM.</p>\n<pre><code>\"keywords\": [\n  \"node-red\"\n],\n</code></pre>\n<p>Add your nodes:</p>\n<pre><code>\"node-red\": {    \n  \"nodes\": {      \n    \"flat\": \"flatter.js\",\n    \"unflat\": \"unflatter.js\"\n  }\n},\n</code></pre>\n<p>Add a test command under scripts:</p>\n<pre><code>\"scripts\": {\n  \"test\": \"mocha \\\"test/**/*_spec.js\\\"\"\n},\n</code></pre>\n<p>To run your unit tests, try <code>npm test</code> in the console.</p>\n<h2>GitHub Actions</h2>\n<p>There are already many templates to choose from. I added the node.js test (which runs on every push) and node.js package actions (which runs on every release created). Personally, I removed the part that publishes to GitHub Packages.</p>\n<p>Create an account with NPM at <a href=\"https://www.npmjs.com/\">https://www.npmjs.com/</a>.\nCreate a token under “Auth Tokens” with type “Publish”, add it as a secret to your repo with the name “npm<em>token”, stick it in the GitHub action as an environment variable `NODE</em>AUTH<em>TOKEN:${{secrets.npm</em>token}}` This should already be in the node.js package template. Create a release in GitHub, (click on “releases” in the top bar and then “Draft a new release”) voila, the GitHub Action will check that it passes the uni tests and then publish the package to NPM.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 6.382978723404256%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAIAAABR8BlyAAAACXBIWXMAAAsSAAALEgHS3X78AAAAOElEQVQI1x3GQRKAMAgDQP//2kooIYDVGfe0V7Xgpoz3TDJI/7Ph97TO09utiq3EWnSMtA0BFPkB7K45+TB8G0EAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"GitHub Repo\"\n        title=\"GitHub Repo\"\n        src=\"/static/9abdfcd83dc1501ab6dabb67e56aa3ac/8c557/github-repo.png\"\n        srcset=\"/static/9abdfcd83dc1501ab6dabb67e56aa3ac/4dcb9/github-repo.png 188w,\n/static/9abdfcd83dc1501ab6dabb67e56aa3ac/5ff7e/github-repo.png 375w,\n/static/9abdfcd83dc1501ab6dabb67e56aa3ac/8c557/github-repo.png 700w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>Hope this helped you out! Chur.</p>"}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"node-red-npm"}}}