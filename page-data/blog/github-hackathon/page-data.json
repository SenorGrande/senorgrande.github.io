{"componentChunkName":"component---src-templates-blog-js","path":"/blog/github-hackathon","result":{"data":{"markdownRemark":{"frontmatter":{"title":"How to create a GitHub Action to run Unit Tests & perform Webhooks","date":"2020-04-8"},"html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.51063829787234%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABZUlEQVQY02MQZLfERHzMptwMRtyMRjxMJvwsZoIclliVMQCxEIeVAJsFEIG0sZgBkZp8kKlBsq5apLpisIyIG1AEqAaIIHrADAsgySDMZQOkJPgdpQSdRbltVWT8gNJ6GlEJCVPCw7sSEqc4OxQDFYhw2QDFJQWcxXjthTmtxfkcgJYxuDmV+XrXpabNSkufnZWzIMC/KSSkPTysMzwMpDMmZkJyygygrJ1Vrr9fI5CRnjk3Ln5SVvZ8OTFPhur6LZ39B6vrN9c1b++bespIJz4ldWZj267yqvVN7bsTkyYF+De6OZcBFfRNPQnUA1QPtCMstFNXPYpBVTZAXzNaSzlMVS7Q1jLHz6feQCtGUtjJRC8RKKipFKKuEKQk7aupFGqgFevuUgFEWkohGorBQG8y8DKZcDMBQ9UYiDgZDDgY9IAMflZzcFAb87CY8LKa8rGaAdlAEaACTgZ9XmYTXmZTAVZzAFMjYgGRsZuyAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"GitHub Hackathon\"\n        title=\"GitHub Hackathon\"\n        src=\"/static/766f920a0350c75dd8cdc3c31b061fc1/8c557/github-hackathon.png\"\n        srcset=\"/static/766f920a0350c75dd8cdc3c31b061fc1/4dcb9/github-hackathon.png 188w,\n/static/766f920a0350c75dd8cdc3c31b061fc1/5ff7e/github-hackathon.png 375w,\n/static/766f920a0350c75dd8cdc3c31b061fc1/8c557/github-hackathon.png 700w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><a href=\"https://github.com/SenorGrande/Test-Webhook\">Test-Webhook - My GitHub Action</a></p>\n<p>My GitHub Action\n<a href=\"https://githubhackathon.com/\">GitHub ran a Hackathon last month to create and submit a GitHub Action.</a>\nI’d never entered a Hackathon before and had been playing around with different Actions ranging from deploying to NPM, running tests, publishing a Gatsby site and deploying to AWS S3. It was time to make my own so I could better understand how they work, this article will share my learnings.</p>\n<p>I wanted to create an Action that would run unit tests in a project, and then HTTP POST the result to a URL. In essence, it runs <code>NPM test</code> and then performs a Webhook. The action consists of the following three files:</p>\n<h2>action.yml</h2>\n<p>This file is used to define the Action. Name, description, and branding are used by the GitHub Marketplace when displaying your Action.\n“runs” defines that Docker is used for this action and to use “Dockerfile”, another file in our repo, to build an image from it.</p>\n<pre><code>name: 'NPM Test &#x26; Webhook'\ndescription: 'Run npm tests &#x26; post result to http endpoint'\nruns:  \n  using: 'docker'  \n  image: 'Dockerfile'\nbranding:\n  icon: 'box'\n  color: 'orange'\n</code></pre>\n<h3>Dockerfile</h3>\n<p>This Dockerfile uses Node as a base image and installs the Curl package so that we can perform an HTTP POST. The “entrypoint” shell script is then copied, and the executable permission is applied to it.</p>\n<pre><code>FROM node:12.16.1 # Install curl\nRUN apt update &#x26;&#x26; apt install -y curl # Add the entry point\nADD entrypoint.sh /entrypoint.sh\nRUN chmod +x /entrypoint.sh # Load the entry point\nENTRYPOINT [\"/entrypoint.sh\"]\n</code></pre>\n<h3>entrypoint.sh</h3>\n<p>This script will run inside the Docker container, it installs the node modules, runs the build script, and then runs the test script. The output from the npm test command is then searched for failed tests. A pass or fail is then POSTed to the webhook URL that is set as a GitHub secret.\nAll echo commands will show up in the GitHub Action logs to make debugging easier.</p>\n<pre><code>#!/bin/bashnpm ci\nnpm run build --if-present\nVALID=$(npm test || true)\necho $VALID\nPASSING=\"$(echo $VALID | grep -o '[0-9] failing')\" # If all tests pass, $PASSING will be empty\nif [ -z \"$PASSING\" ]\nthen\n  RESULTS=\"pass\"\nelse\n  RESULTS=\"fail\"\nfi RES=$(curl --write-out '%{http_code}' --silent --output /dev/null -X POST -H \"Content-Type: application/json\" --data \"{ \\\"data\\\": \\\"$RESULTS\\\" }\"  $WEBHOOK_URL) # If RESULTS is fail or curl returned 404, throw an error\nif [ \"$RES\" != \"200\" ]\nthen\n  echo \"*** Post failed\"\n  exit 64\nelif [ $RESULTS = \"fail\" ]\nthen\n  echo \"*** NPM Test failed\"\n  exit 64\nfi\n</code></pre>\n<p>How to Use the GitHub Action</p>\n<p>With our Action done, here’s an example of how to implement it to run on another GitHub project. Create a new YAML file in <code>.github/workflows</code>. (Create the directory in your repository if it doesn’t already exist. Having an “.” at the beginning makes it a hidden folder, <code>ls -a</code> will show all files and directories).</p>\n<p>First, we use actions/checkout, this will check out the code and allow our Action to run the NPM commands successfully. We then provide the webhook URL as an environment variable which has been set as a secret on the repository.</p>\n<pre><code>name: NPM Test &#x26; Webhook\non: push\n\njobs:\n  webhook:\n    name: NPM Test &#x26; Webhook action\n    runs-on: ubuntu-latest\n    steps:\n    - uses: actions/checkout@v1\n    - name: Run NPM Test &#x26; POST\n      uses: SenorGrande/test-webhook@v1\n      env:\n        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}\n</code></pre>\n<p><a href=\"https://github.com/SenorGrande/node-app\">Have a look at my simple Node server repo that I used for testing if you’re lost</a></p>\n<h2>Using the Action to change the colour of an RGB LED</h2>\n<p>I used this Action to POST to an HTTP endpoint on my Node-RED Docker container running on my Raspberry Pi. Node-RED would then change the colour of an RGB LED to green if the tests all passed, otherwise it would change to red.\nTo read on how I got Node-RED and Johnny-Five working in a Docker container, check out my previous article:</p>\n<p><a href=\"https://medium.com/@hewett.j.connor/using-johnny-five-with-node-red-and-docker-98daa5b31cc\">Using Johnny Five with Node-RED and Docker</a></p>\n<p>Cheers for reading!</p>"}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"github-hackathon"}}}